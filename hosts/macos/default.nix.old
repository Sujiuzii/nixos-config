{ pkgs, ... }:

{
  # List packages installed in system profile. To search by name, run:
  # $ nix-env -qaP | grep wget
  environment.systemPackages = with pkgs; [
    vim
    telegram-desktop
    termpdfpy
  ];

  # Auto upgrade nix package and the daemon service.
  # services.nix-daemon.enable = true;
  # nix.package = pkgs.nix;
  nix = {
    enable = true;
    
    settings = {
      experimental-features = [ "nix-command" "flakes" ];

      substituters = [
        "https://mirrors.ustc.edu.cn/nix-channels/store"
      ];

      trusted-public-keys = [
        "cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY="
      ];

      trusted-users = [ "root" "suhui" ];
    };
  };


  # Necessary for using flakes on this system.
  # nix.enable = true;
  # nix.settings.experimental-features = "nix-command flakes";

  # Create /etc/zshrc that loads the nix-darwin environment.
  # programs.zsh.enable = true;  # default shell on catalina

  # Set Git commit hash for darwin-version.
  # system.configurationRevision = self.rev or self.dirtyRev or null;

  # Used for backwards compatibility, please read the changelog before changing.
  # $ darwin-rebuild changelog
  system.stateVersion = 5;

  # The platform the configuration will be used on.
  nixpkgs.hostPlatform = "aarch64-darwin";

  system.primaryUser = "suhui";

  users.users.suhui = {
    name = "suhui";
    home = "/Users/suhui";
  };

  fonts.packages = with pkgs; [
    maple-mono.NF
  ];

  programs.direnv = {
    enable = true;
    nix-direnv.enable = true;
  };

  services.aerospace = {
    enable = true;

    settings = {
      after-login-command = [];
      after-startup-command = [ "exec-and-forget sketchybar" ];
      
      exec-on-workspace-change = [
        "/bin/bash"
        "-c"
        "sketchybar --trigger aerospace_workspace_change FOCUSED_WORKSPACE=$AEROSPACE_FOCUSED_WORKSPACE PREV_WORKSPACE=$AEROSPACE_PREV_WORKSPACE"
      ];

      enable-normalization-flatten-containers = true;
      enable-normalization-opposite-orientation-for-nested-containers = true;

      accordion-padding = 30;
      default-root-container-layout = "accordion";
      default-root-container-orientation = "vertical";

      key-mapping.preset = "qwerty";
      on-focused-monitor-changed = [ "move-mouse monitor-lazy-center" ];

      gaps = {
        inner.horizontal = 18;
        inner.vertical = 18;
        outer.left = 18;
        outer.bottom = 18;
        outer.top = 18;
        outer.right = 18;
      };

      mode.main.binding = {
        # å¸ƒå±€åˆ‡æ¢
        "alt-slash" = "layout tiles horizontal vertical";
        "alt-comma" = "layout accordion vertical horizontal";

        # ç„¦ç‚¹ç§»åŠ¨
        "alt-h" = "focus left";
        "alt-j" = "focus down";
        "alt-k" = "focus up";
        "alt-l" = "focus right";

        # çª—å£ç§»åŠ¨
        "alt-shift-h" = "move left";
        "alt-shift-j" = "move down";
        "alt-shift-k" = "move up";
        "alt-shift-l" = "move right";

        # å·¥ä½œåŒºåˆ‡æ¢
        "alt-1" = "workspace 1";
        "alt-2" = "workspace 2";
        "alt-3" = "workspace 3";
        "alt-4" = "workspace 4";
        "alt-5" = "workspace 5";
        "alt-6" = "workspace 6";
        "alt-7" = "workspace 7";
        "alt-8" = "workspace 8";
        "alt-9" = "workspace 9";
        "alt-0" = "workspace 0";
        "alt-d" = "workspace D";
        "alt-s" = "workspace S";
        "alt-b" = "workspace B";
        "alt-t" = "workspace T";
        "alt-v" = "workspace V";
        "alt-n" = "workspace N";
        "alt-m" = "workspace M";

        # ç§»åŠ¨çª—å£åˆ°å·¥ä½œåŒº
        "alt-shift-1" = "move-node-to-workspace 1";
        "alt-shift-2" = "move-node-to-workspace 2";
        "alt-shift-3" = "move-node-to-workspace 3";
        "alt-shift-4" = "move-node-to-workspace 4";
        "alt-shift-5" = "move-node-to-workspace 5";
        "alt-shift-6" = "move-node-to-workspace 6";
        "alt-shift-7" = "move-node-to-workspace 7";
        "alt-shift-8" = "move-node-to-workspace 8";
        "alt-shift-9" = "move-node-to-workspace 9";
        "alt-shift-0" = "move-node-to-workspace 0";
        "alt-shift-d" = "move-node-to-workspace D";
        "alt-shift-s" = "move-node-to-workspace S";
        "alt-shift-b" = "move-node-to-workspace B";
        "alt-shift-t" = "move-node-to-workspace T";
        "alt-shift-v" = "move-node-to-workspace V";
        "alt-shift-n" = "move-node-to-workspace N";
        "alt-shift-m" = "move-node-to-workspace M";

        # å…¶ä»–åŠŸèƒ½
        "alt-shift-f" = "fullscreen";
        "alt-tab" = "workspace-back-and-forth";
        "alt-shift-tab" = "move-workspace-to-monitor --wrap-around next";
        "alt-shift-semicolon" = "mode service";
        "alt-shift-r" = "mode resize";
      };

      # === Resize æ¨¡å¼ ===
      mode.resize.binding = {
        h = "resize width -50";
        j = "resize height +50";
        k = "resize height -50";
        l = "resize width +50";
        b = "balance-sizes";
        minus = "resize smart -50";
        equal = "resize smart +50";
        enter = "mode main";
        esc = "mode main";
      };

      # === Service æ¨¡å¼ ===
      mode.service.binding = {
        esc = [ "reload-config" "mode main" ];
        r = [ "flatten-workspace-tree" "mode main" ];
        f = [ "layout floating tiling" "mode main" ];
        backspace = [ "close-all-windows-but-current" "mode main" ];
        "alt-shift-h" = [ "join-with left" "mode main" ];
        "alt-shift-j" = [ "join-with down" "mode main" ];
        "alt-shift-k" = [ "join-with up" "mode main" ];
        "alt-shift-l" = [ "join-with right" "mode main" ];
      };

      on-window-detected = [
        {
          "if".app-id = "com.github.wez.wezterm";
          run = "move-node-to-workspace T";
        }
        {
          "if".app-id = "net.kovidgoyal.kitty";
          run = "move-node-to-workspace T";
        }
        {
          "if".app-id = "com.mitchellh.ghostty";
          run = "move-node-to-workspace T";
        }
        {
          "if".app-id = "com.apple.Music";
          run = "move-node-to-workspace M";
        }
        {
            "if".app-id = "com.google.Chrome";
          run = "move-node-to-workspace B";
        }
        {
            "if".app-id = "org.mozilla.firefox";
          run = "move-node-to-workspace B";
        }
        {
          "if".app-id = "company.thebrowser.Browser"; # Arc
          run = "move-node-to-workspace B";
        }
        {
          "if".app-id = "com.microsoft.VSCode";
          run = "move-node-to-workspace V";
        }
        {
          "if".app-id = "com.todesktop.230313mzl4w4u92"; # Cursor
          run = "move-node-to-workspace V";
        }
        {
          "if".app-id = "com.google.android.studio";
          run = "move-node-to-workspace I";
        }
        {
          "if".app-id = "com.apple.dt.Xcode";
          run = "move-node-to-workspace I";
        }
        {
          "if".app-id = "com.tinyspeck.slackmacgap";
          run = "move-node-to-workspace S";
        }
        {
          "if".app-id = "com.apple.iphonesimulator";
          run = "move-node-to-workspace T";
        }
        {
          "if".app-id = "notion.id";
          run = "move-node-to-workspace N";
        }
        {
          "if".app-id = "com.tencent.qq";
          run = "move-node-to-workspace D";
        }
        {
          "if".app-id = "com.apple.finder";
          run = "layout floating";
        }
        {
          "if".app-id = "com.apple.ActivityMonitor";
          run = "layout floating";
        }
        {
          "if".app-id = "NULL-APP-BUNDLE-ID";
          run = "move-node-to-workspace T";
        }
      ];
    };
  };

  # 1. å¯ç”¨å¹¶é…ç½®å¸¸ç”¨å·¥å…· (æ›¿ä»£åŸæœ¬çš„ manual install å’Œ alias)
  
  # æ›¿ä»£: alias cd="z" å’Œ eval "$(zoxide init zsh)"
  programs.zoxide = {
    enable = true;
    enableZshIntegration = true;
    options = [ "--cmd cd" ]; # è¿™ä¼šè‡ªåŠ¨æŠŠ cd æ›¿æ¢ä¸º z
  };

  # æ›¿ä»£: eza çš„å„ç§ alias
  programs.eza = {
    enable = true;
    enableZshIntegration = true;
    icons = "auto";
    git = true;
    extraOptions = [ "--group-directories-first" "--header" ];
  };

  # æ›¿ä»£: fzf install å’Œ eval "$(fzf --zsh)"
  programs.fzf = {
    enable = true;
    enableZshIntegration = true;
  };
  
  # æ›¿ä»£: lazygit
  programs.lazygit.enable = true;

  # æ›¿ä»£: Oh My Posh
  programs.oh-my-posh = {
    enable = true;
    enableZshIntegration = true;
    # å‡è®¾ä½ çš„é…ç½®æ–‡ä»¶åœ¨åŸæ¥çš„ä½ç½®ï¼Œæˆ–è€…ä½ å¯ä»¥æŠŠå®ƒç§»åˆ° nix store ä¸­ç®¡ç†
    # å¦‚æœä½ æƒ³ä¿æŒåŸæ ·è¯»å–æœ¬åœ°æ–‡ä»¶ï¼š
    configFile = "${config.home.homeDirectory}/.config/oh-my-posh/themes/powerlevel10k-custom.yaml";
    
    # æˆ–è€…ï¼ˆè¿›é˜¶ç©æ³•ï¼‰ï¼šæŠŠ yaml å†…å®¹ç›´æ¥å†™åœ¨ nix é‡Œï¼Œæˆ–è€…æŠŠæ–‡ä»¶æ”¾åœ¨ flake ç›®å½•ä¸‹å¼•ç”¨
    # configFile = ./path/to/my-theme.yaml; 
  };

  # 2. Zsh æ ¸å¿ƒé…ç½®
  programs.zsh = {
    enable = true;
    enableCompletion = true; # æ›¿ä»£ autoload -Uz compinit
    
    # æ›¿ä»£: Zinit çš„ autosuggestions å’Œ syntax-highlighting
    autosuggestions.enable = true;
    syntaxHighlighting = {
      enable = true;
      # ä½ çš„è‡ªå®šä¹‰é«˜äº®æ ·å¼
      styles = {
        "command" = "fg=white";
        "alias" = "fg=white";
        "builtin" = "fg=white";
        "precommand" = "fg=white";
        "default" = "fg=white";
        "function" = "fg=white";
      };
    };

    # æ›¿ä»£: Zinit snippets (OMZL::git.zsh, OMZP::git, aws, kubectl, etc.)
    # Home Manager å†…ç½®äº† oh-my-zsh æ¨¡å—ï¼Œç›´æ¥å¯ç”¨æ’ä»¶å³å¯
    oh-my-zsh = {
      enable = true;
      plugins = [ 
        "git" 
        "aws" 
        "kubectl" 
        "kubectx" 
        "command-not-found" 
        # "vi-mode" # æ³¨æ„ï¼šä½ ç”¨çš„æ˜¯ jeffreytse/zsh-vi-modeï¼Œä¸æ˜¯ omz è‡ªå¸¦çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸åŠ 
      ];
    };

    # æ›¿ä»£: æ‰‹åŠ¨å®šä¹‰çš„ aliases
    shellAliases = {
      ".." = "cd ..";
      "..." = "cd ../..";
      "n" = "nvim";
      "lg" = "lazygit";
      # eza çš„ alias å·²ç»è¢« programs.eza å¤„ç†äº†å¤§éƒ¨åˆ†ï¼Œ
      # å¦‚æœä½ éœ€è¦ç‰¹å®šçš„ ltree:
      "ltree" = "eza --tree --level=2 --long --icons";
      "clear" = "clear && tmux clear-history 2>/dev/null || clear"; # ç¨å¾®ä¼˜åŒ–äº†ä¸€ä¸‹ä½ çš„ clear å‡½æ•°
    };

    # æ›¿ä»£: History é…ç½®
    history = {
      size = 5000;
      save = 5000;
      path = "${config.home.homeDirectory}/.zsh_history";
      ignoreDups = true;
      share = true;
      ignoreSpace = true;
    };

    # 3. Zsh æ’ä»¶ (å¤„ç†é‚£äº›ä¸æ˜¯ OMZ å†…ç½®çš„æ’ä»¶)
    plugins = [
      {
        # æ›¿ä»£: zinit light jeffreytse/zsh-vi-mode
        name = "zsh-vi-mode";
        src = pkgs.zsh-vi-mode;
        file = "share/zsh-vi-mode/zsh-vi-mode.plugin.zsh";
      }
      {
        # æ›¿ä»£: zinit light Aloxaf/fzf-tab
        name = "fzf-tab";
        src = pkgs.zsh-fzf-tab;
        file = "share/fzf-tab/fzf-tab.plugin.zsh";
      }
    ];

    # 4. ç¯å¢ƒå˜é‡
    sessionVariables = {
      EDITOR = "nvim";
      GPG_TTY = "$(tty)";
      # æ³¨æ„ï¼šPATH åœ¨ Nix ä¸­é€šå¸¸ä¸å»ºè®®ç›´æ¥è¦†ç›–ï¼Œè€Œæ˜¯é€šè¿‡ home.packages æ·»åŠ åŒ…ã€‚
      # ä½†å¦‚æœä½ éœ€è¦ä¿ç•™æ‰‹åŠ¨è·¯å¾„ï¼Œå¯ä»¥åœ¨ initExtra ä¸­ exportï¼Œæˆ–è€…åœ¨è¿™é‡Œç”¨åˆ—è¡¨æ‹¼æ¥ (ç¨å¾®éº»çƒ¦ç‚¹)ã€‚
    };

    # 5. æ‰€æœ‰çš„â€œå‰©ä½™ä»£ç â€ (Functions, zstyles, keybindings, extra PATHs)
    initExtra = ''
      # === PATHs ===
      export PATH="$PATH:/Users/praveenkumar/FlutterDev/flutter/bin"
      export PATH="$GOPATH/bin:$PATH"
      export PATH="$PATH:/Users/praveenkumar/istio-1.26.3/bin"
      # Homebrew path (Nix-darwin é€šå¸¸ä¼šè‡ªåŠ¨å¤„ç†ï¼Œä½†ä¸ºäº†ä¿é™©å¯ä»¥ç•™ç€)
      if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
      fi

      # === Zsh Vi Mode Customization ===
      ZVM_VI_ESCAPE_BINDKEY=jj
      ZVM_VI_INSERT_ESCAPE_BINDKEY=$ZVM_VI_ESCAPE_BINDKEY
      ZVM_VI_VISUAL_ESCAPE_BINDKEY=$ZVM_VI_ESCAPE_BINDKEY
      ZVM_VI_OPPEND_ESCAPE_BINDKEY=$ZVM_VI_ESCAPE_BINDKEY
      
      # Restore FZF Ctrl+R
      # (Home Manager çš„ fzf æ¨¡å—é€šå¸¸ä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸ªï¼Œå¦‚æœå‘ç°æ— æ•ˆå†ä¿ç•™ä¸‹é¢è¿™è¡Œ)
      zvm_after_init_commands+=('source ${pkgs.fzf}/share/fzf/key-bindings.zsh')

      # === Completion Styling (FZF-Tab) ===
      zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
      zstyle ':completion:*' list-colors "''${(s.:.)LS_COLORS}"
      zstyle ':completion:*' menu no
      zstyle ':fzf-tab:complete:cd:*' fzf-preview 'ls --color $realpath'
      zstyle ':fzf-tab:complete:__zoxide_z:*' fzf-preview 'ls --color $realpath'

      # === Pomodoro Functions ===
      function work () {
        timer 25m
        osascript -e 'display notification "Pomodoro" with title "Work Timer is up! Take a Break ğŸ˜Š" sound name "Crystal"'
      }

      function rest () {
        timer 5m
        osascript -e 'display notification "Pomodoro" with title "Break is over! Get back to work ğŸ˜¬" sound name "Crystal"'
      }
      
      # source <(kubectl completion zsh)
    '';
  };

  homebrew = {
    enable = true;
    onActivation.cleanup = "zap";
    onActivation.autoUpdate = true;
    onActivation.upgrade = true;

    taps = [
        "caarlos0/tap"
        "felixkratz/formulae"
        "TheBoredTeam/boring-notch""
        # "jandedobbeleer/oh-my-posh"
    ];
    brews = [
        "utimer"
        "cloudflared"
        "doctl"
        # "eza"
        "fastfetch"
        "fd"
        "sketchybar"
        # "fzf"
        "gemini-cli"
        "git"
        "glow"
        "go"
        "helm"
        # "oh-my-posh"
        # "lazygit"
        "neovim"
        "redis"
        "ripgrep"
        "tmux"
        "tpm"
        "yazi"
        # "zoxide"
        "mihomo"
        "fish"
        "kubernetes-cli"
        "fancy-cat"
        "btop"
    ];
    casks = [
        "1password-cli"
        "claude-code"
        "font-sf-pro"
        "ghostty"
        "kitty"
        "obsidian"
        "raycast"
        "sf-symbols"
        "wezterm"
        "clash-verge-rev"
        "qq"
        "firefox"
        "bluestacks"
        "bilibili"
        "anki"
        "visual-studio-code"
        "wechat"
        "squirrel-app"
        "tailscale-app"
        "tencent-meeting"
        "steam"
        "boring-notch"
    ];
  };
}
