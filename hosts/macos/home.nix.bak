{ config, pkgs, ... }:

{
  home.username = "suhui";
  home.homeDirectory = "/Users/suhui";
  home.stateVersion = "24.11";

  # è®© Home Manager ç®¡ç†è‡ªå·±
  programs.home-manager.enable = true;

  # ============================================================
  # 1. åŸæœ‰çš„ Dotfiles é“¾æ¥ (ä¿æŒä¸å˜ï¼Œé™¤äº† zshrc)
  # ============================================================
  # xdg.configFile.aerospace.source = ../../dotfiles/aerospace;
  xdg.configFile.fonts.source = ../../dotfiles/fonts;
  xdg.configFile.ghostty.source = ../../dotfiles/ghostty;
  # xdg.configFile.homebrew.source = ../../dotfiles/homebrew;
  xdg.configFile.kitty.source = ../../dotfiles/kitty;
  # xdg.configFile.lazygit.source = ../../dotfiles/lazygit; # ä¹Ÿå¯ä»¥è®© HM ç®¡ç†ï¼Œè§ä¸‹æ–‡
  xdg.configFile.nvim.source = ../../dotfiles/nvim;
  
  # è¿™é‡Œä¿ç•™ oh-my-posh çš„æºæ–‡ä»¶é“¾æ¥ï¼Œå› ä¸ºä¸‹é¢çš„é…ç½®ä¼šè¯»å–å®ƒ
  xdg.configFile."oh-my-posh".source = ../../dotfiles/oh-my-posh;
  
  xdg.configFile.sketchybar.source = ../../dotfiles/sketchybar;
  # xdg.configFile.tmux.source = ../../dotfiles/tmux;
  xdg.configFile.wallpapers.source = ../../dotfiles/wallpapers;
  xdg.configFile.wezterm.source = ../../dotfiles/wezterm;
  xdg.configFile.yazi.source = ../../dotfiles/yazi;
  
  # âš ï¸ æ³¨æ„ï¼šè¿™é‡Œä¸å† symlink zshrcï¼Œå› ä¸ºæˆ‘ä»¬è¦ç”¨ä¸‹é¢çš„ programs.zsh ç”Ÿæˆå®ƒ
  # xdg.configFile.zshrc.source = ../../dotfiles/zshrc;

  # ============================================================
  # 2. æ–°çš„å£°æ˜å¼ Shell ç¯å¢ƒé…ç½®
  # ============================================================

  # === æ ¸å¿ƒå·¥å…· ===
  programs.zoxide = {
    enable = true;
    enableZshIntegration = true;
    options = [ "--cmd cd" ];
  };

  programs.eza = {
    enable = true;
    enableZshIntegration = true;
    icons = "auto";
    git = true;
    extraOptions = [ "--group-directories-first" "--header" ];
  };

  programs.fzf = {
    enable = true;
    enableZshIntegration = true;
  };
  
  programs.lazygit.enable = true;

  programs.direnv = {
    enable = true;
    nix-direnv.enable = true;
  };

  # === Oh My Posh ===
  programs.oh-my-posh = {
    enable = true;
    enableZshIntegration = true;
    # è¿™é‡Œå¼•ç”¨ä½ ä¸Šé¢ xdg.configFile é“¾æ¥å¥½çš„è·¯å¾„
    configFile = "${config.home.homeDirectory}/.config/oh-my-posh/themes/powerlevel10k-custom.yaml";
  };

  # === Zsh é…ç½® ===
  programs.zsh = {
    enable = true;
    enableCompletion = true;
    autosuggestion.enable = true;
    syntaxHighlighting = {
      enable = true;
      styles = {
        "command" = "fg=white";
        "alias" = "fg=white";
        "builtin" = "fg=white";
        "precommand" = "fg=white";
        "default" = "fg=white";
        "function" = "fg=white";
      };
    };

    oh-my-zsh = {
      enable = true;
      plugins = [ 
        "git" "aws" "kubectl" "kubectx" "command-not-found" 
      ];
    };

    shellAliases = {
      ".." = "cd ..";
      "..." = "cd ../..";
      "n" = "nvim";
      "lg" = "lazygit";
      "ltree" = "eza --tree --level=2 --long --icons";
      # ä¼˜åŒ–åçš„ clear
      "clear" = "clear && tmux clear-history 2>/dev/null || clear";
    };

    history = {
      size = 5000;
      save = 5000;
      path = "${config.home.homeDirectory}/.zsh_history";
      ignoreDups = true;
      share = true;
      ignoreSpace = true;
    };

    plugins = [
      {
        name = "zsh-vi-mode";
        src = pkgs.zsh-vi-mode;
        file = "share/zsh-vi-mode/zsh-vi-mode.plugin.zsh";
      }
      {
        name = "fzf-tab";
        src = pkgs.zsh-fzf-tab;
        file = "share/fzf-tab/fzf-tab.plugin.zsh";
      }
    ];

    sessionVariables = {
      EDITOR = "nvim";
      GPG_TTY = "$(tty)";
    };

    # ä½ çš„è‡ªå®šä¹‰è„šæœ¬å’Œå‡½æ•°
    initContent = ''
      # === PATHs ===
      # æ³¨æ„ï¼šNix ä¼šè‡ªåŠ¨å¤„ç†å¤§éƒ¨åˆ† PATHï¼Œä½†å¦‚æœä½ æœ‰æ‰‹åŠ¨å®‰è£…çš„ sdkï¼Œå¯ä»¥åœ¨è¿™é‡Œä¿ç•™
      export PATH="$PATH:/Users/praveenkumar/FlutterDev/flutter/bin"
      export PATH="$GOPATH/bin:$PATH"
      export PATH="$PATH:/Users/praveenkumar/istio-1.26.3/bin"
      
      if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
      fi

      # === Vi Mode Config ===
      ZVM_VI_ESCAPE_BINDKEY=jj
      ZVM_VI_INSERT_ESCAPE_BINDKEY=$ZVM_VI_ESCAPE_BINDKEY
      ZVM_VI_VISUAL_ESCAPE_BINDKEY=$ZVM_VI_ESCAPE_BINDKEY
      ZVM_VI_OPPEND_ESCAPE_BINDKEY=$ZVM_VI_ESCAPE_BINDKEY
      zvm_after_init_commands+=('source ${pkgs.fzf}/share/fzf/key-bindings.zsh')

      # === Styles ===
      zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
      zstyle ':completion:*' list-colors "''${(s.:.)LS_COLORS}"
      zstyle ':completion:*' menu no
      zstyle ':fzf-tab:complete:cd:*' fzf-preview 'ls --color $realpath'
      zstyle ':fzf-tab:complete:__zoxide_z:*' fzf-preview 'ls --color $realpath'

      # === Pomodoro ===
      function work () {
        timer 25m
        osascript -e 'display notification "Pomodoro" with title "Work Timer is up! Take a Break ğŸ˜Š" sound name "Crystal"'
      }
      function rest () {
        timer 5m
        osascript -e 'display notification "Pomodoro" with title "Break is over! Get back to work ğŸ˜¬" sound name "Crystal"'
      }
    '';
  };

  programs.tmux = {
    enable = true;
    
    # === æ ¸å¿ƒè®¾ç½® ===
    shell = "${pkgs.zsh}/bin/zsh";  # âœ… å…³é”®ä¿®æ­£ï¼šå¼ºåˆ¶ä½¿ç”¨ Nix ç®¡ç†çš„ Zsh
    terminal = "tmux-256color";     # å¯¹åº” set -g default-terminal
    historyLimit = 100000;          # å¢åŠ å†å²è®°å½•
    baseIndex = 1;                  # å¯¹åº” set -g base-index 1
    mouse = true;                   # å¯¹åº” set -g mouse on
    escapeTime = 0;                 # å¯¹åº” set -g escape-time 0
    keyMode = "vi";                 # å¯¹åº” set-window-option -g mode-keys vi
    shortcut = "a"; # è¿™ä¼šè‡ªåŠ¨è®¾ç½® prefix ä¸º C-aï¼Œå¹¶å¤„ç† send-prefix
    
    # === æ’ä»¶ç®¡ç† (æ›¿ä»£ TPM) ===
    # Nix ä¼šè‡ªåŠ¨å®‰è£…å¹¶åŠ è½½è¿™äº›æ’ä»¶
    plugins = with pkgs.tmuxPlugins; [
      sensible             # tmux-sensible
      vim-tmux-navigator   # christoomey/vim-tmux-navigator
      yank                 # tmux-yank
      # æ³¨æ„ï¼štpm ä¸éœ€è¦äº†ï¼ŒNix å°±æ˜¯ä½ çš„åŒ…ç®¡ç†å™¨
    ];

    # === è‡ªå®šä¹‰é…ç½® (Bindings & Theme) ===
    # è¿™ä¸€éƒ¨åˆ†åŒ…å«äº†æ‰€æœ‰æ— æ³•ç›´æ¥æ˜ å°„åˆ° Nix é€‰é¡¹çš„é…ç½®
    extraConfig = ''
      # === Fix Colors ===
      set -ag terminal-overrides ",xterm-256color:RGB"

      # === Window Management Bindings ===
      unbind %
      bind | split-window -h -c "#{pane_current_path}"
      unbind '"'
      bind - split-window -v -c "#{pane_current_path}"
      
      # Renumber windows
      set -g renumber-windows on
      
      # Set Clipboard
      set -g set-clipboard on

      # === Reload Config ===
      # æ³¨æ„ï¼šåœ¨ Nix ç¯å¢ƒä¸‹ï¼Œé€šå¸¸å»ºè®®è¿è¡Œ rebuild å‘½ä»¤ï¼Œè€Œä¸æ˜¯åœ¨è¯¥æ–‡ä»¶å†… reload
      unbind r
      bind r source-file ${config.xdg.configHome}/tmux/tmux.conf \; display "Config reloaded!"

      # === Copy Mode Bindings (Vi) ===
      bind-key -T copy-mode-vi v send-keys -X begin-selection
      bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
      bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

      # === Resize Panes ===
      bind -r j resize-pane -D 5
      bind -r k resize-pane -U 5
      bind -r l resize-pane -R 5
      bind -r h resize-pane -L 5
      bind -r m resize-pane -Z

      # === Clear History ===
      bind-key -n C-S-k send-keys -R \; clear-history

      # ==========================================
      # === Cyberdream Theme Configuration ===
      # ==========================================
      
      # Color Variables
      # Nix config string é‡Œé¢å¼•ç”¨å˜é‡æœ‰ç‚¹éº»çƒ¦ï¼Œè¿™é‡Œç›´æ¥å±•å¼€å†™æˆ–è€…ç”¨ % å®šä¹‰
      %hidden color_bg="#16181a"
      %hidden color_bg_alt="#1e2124"
      %hidden color_fg="#d3d7df"
      %hidden color_blue="#5ea1ff"
      %hidden color_grey="#7b8496"
      %hidden color_border="#3c4048"
      %hidden color_red="#ff6e5e"
      %hidden color_yellow="#f1ff5e"
      %hidden color_purple="#bd5eff"
      %hidden color_cyan="#5ef1ff"

      # Apply Theme
      set -g status-style "bg=$color_bg,fg=$color_fg"
      set -g status-left-style "bg=$color_bg,fg=$color_blue"
      set -g status-right-style "bg=$color_bg,fg=$color_blue"

      # Window status colors
      set -g window-status-style "bg=$color_bg_alt,fg=$color_grey"
      set -g window-status-current-style "bg=$color_blue,fg=$color_bg,bold"
      set -g window-status-activity-style "bg=$color_red,fg=$color_bg"
      set -g window-status-bell-style "bg=$color_yellow,fg=$color_bg"

      # Pane border colors
      set -g pane-border-style "fg=$color_border"
      set -g pane-active-border-style "fg=$color_blue"

      # Message colors
      set -g message-style "bg=$color_blue,fg=$color_bg"
      set -g message-command-style "bg=$color_purple,fg=$color_bg"

      # Copy mode colors
      set -g mode-style "bg=$color_cyan,fg=$color_bg"

      # Status bar configuration
      set -g status-right-length 100
      set -g status-left-length 100
      set -g status-left ""

      # Status Bar Content
      # æ³¨æ„ï¼šåœ¨ Nix string ä¸­ï¼Œ$ ç¬¦å·éœ€è¦è½¬ä¹‰ï¼Œä½†è¿™é‡Œæ˜¯ extraConfigï¼Œé€šå¸¸ä¸éœ€è¦ç‰¹æ®Šè½¬ä¹‰ï¼Œ
      # é™¤éä½ ç”¨äº† Nix å˜é‡æ’å€¼ã€‚ä¸‹é¢çš„é…ç½®åº”è¯¥æ˜¯å®‰å…¨çš„ã€‚
      set -g status-right "#[fg=$color_fg,bg=$color_blue] #(tmux list-sessions | wc -l | tr -d ' ') #[fg=$color_fg,bg=$color_bg] #{session_name} "

      set -g window-status-format "#[fg=$color_fg,bg=$color_bg] #{b:pane_current_path}#{?window_zoomed_flag, (î®),} #[fg=$color_bg,bg=$color_grey] #I "
      set -g window-status-current-format "#[fg=$color_fg,bg=$color_bg] #{b:pane_current_path}#{?window_zoomed_flag, (î®),} #[fg=$color_fg,bg=$color_blue] #I "
      
      # Transparent Background (Last override)
      set -g status-bg default
      set -g status-style bg=default
    '';
  };
}
